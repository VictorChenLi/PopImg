<div class="container mt-2">
  <div class="w-100 text-center">
    <h2>Pop Image via URL</h2>
  </div>
  <p id="error_msg" style="color: red" hidden>Error msg</p>
  <!-- <p>Image URL:<input id="imgurl" placeholder="http://" /></p> -->
  <label for="imgurl" class="form-label">Image URL</label>
  <div class="input-group mb-3">
    <input
      id="imgurl"
      type="text"
      class="form-control"
      placeholder="http://"
      aria-label="Image URL"
      aria-describedby="basic-addon2"
    />
  </div>

  <label for="basic-url" class="form-label">Scale Mode</label>
  <select name="scaleMode" id="scaleMode" class="form-select">
    <option selected>Fill</option>
    <option value="1">Fit</option>
    <option value="2">Crop</option>
    <option value="3">Tile</option>
  </select>

  <div class="mt-3">
    <button type="button" class="btn btn-primary px-4" id="pop">Pop</button>
    <button type="button" class="btn btn-secondary mx-3" id="cancel">
      Close
    </button>
  </div>
</div>

<!-- <iframe src="" width="100%" height="600px"></iframe> -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
  crossorigin="anonymous"
/>
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
  crossorigin="anonymous"
></script>

<script>
  window.onload = (e) => {
    // auto focus
    const urlInput = document.getElementById("imgurl");
    urlInput.focus();

    parent.postMessage({ pluginMessage: { type: "initial-state" } }, "*");
  };

  function fetchImg(windowHandle, imgurl) {
    fetch(imgurl)
      .then((r) => {
        if ((r.status + "")[0] != "2")
          throw Error(`HTTP ${r.status} ${r.statusText}`);
        return r.arrayBuffer();
      })
      .then((a) =>
        windowHandle.postMessage(
          {
            pluginMessage: {
              type: "pop-image",
              data: new Uint8Array(a),
              scaleMode: scaleMode,
            },
          },
          "*"
        )
      )
      .catch((err) => {
        console.log(err + "error");
        // use no-cors to check if the image is reachable or not
        fetch(imgurl, { mode: "no-cors" })
          .then((r) => {
            console.log("reachable");
            // use proxy
            imgurl = "https://cors-anywhere.herokuapp.com/" + imgurl;
            console.log(imgurl);
            fetchImg(windowHandle, imgurl);
          })
          .catch((err) => {
            windowHandle.postMessage(
              { pluginMessage: { type: "error", error: "" + err } },
              "*"
            );
          });
      });
  }

  document.getElementById("pop").onclick = () => {
    const urlInput = document.getElementById("imgurl");
    const scaleModeInput = document.getElementById("scaleMode");
    const imgurl = urlInput.value;
    const scaleMode = scaleModeInput.value;

    if (!imgurl) {
      parent.postMessage(
        { pluginMessage: { type: "error", error: "Need URL to continue!" } },
        "*"
      );
    }
    // else fetchImg(parent, imgurl);
    else {
      fetch(imgurl)
        .then((r) => {
          if ((r.status + "")[0] != "2")
            throw Error(`HTTP ${r.status} ${r.statusText}`);
          return r.arrayBuffer();
        })
        .then((a) =>
          parent.postMessage(
            {
              pluginMessage: {
                type: "pop-image",
                data: new Uint8Array(a),
                scaleMode: scaleMode,
              },
            },
            "*"
          )
        )
        .catch((err) => {
          console.log(err + "error");
          // use no-cors to check if the image is reachable or not
          fetch(imgurl, { mode: "no-cors" })
            .then((r) => {
              console.log("reachable");
              // use proxy
              const new_imgurl =
                "https://cors-anywhere.herokuapp.com/" + imgurl;
              fetch(new_imgurl)
                .then((r) => {
                  if ((r.status + "")[0] != "2")
                    throw Error(`HTTP ${r.status} ${r.statusText}`);
                  return r.arrayBuffer();
                })
                .then((a) =>
                  parent.postMessage(
                    {
                      pluginMessage: {
                        type: "pop-image",
                        data: new Uint8Array(a),
                        scaleMode: scaleMode,
                      },
                    },
                    "*"
                  )
                )
                .catch((err) => {
                  parent.postMessage(
                    { pluginMessage: { type: "error", error: "" + err } },
                    "*"
                  );
                });
            })
            .catch((err) => {
              parent.postMessage(
                { pluginMessage: { type: "error", error: "" + err } },
                "*"
              );
            });
        });
    }
  };

  document.getElementById("cancel").onclick = () => {
    parent.postMessage({ pluginMessage: { type: "cancel" } }, "*");
  };
</script>
